---
title: "Opera"
author: "Olivia Brode-Roger"
date: "12/21/2019"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(hrbrthemes)
```

```{r data, }
opera <- read_csv("opera.csv")
```

```{r plots, }
opera_tors <- opera %>% 
    group_by(time, flow, flow_src, flow_dst, packet) %>% 
        summarize(src = max(src), # t > r, so max gets the tor...
                  dst = max(dst), # this is... hacky...
                  tor = min(src))

opera_tors %>%
    filter(flow %in% c("Flow 21False", "Flow 24True")) %>% 
    #filter(flow %in% c("Flow 32", "Flow 5", "Flow 1", "Flow 24", "Flow 29", "Flow 35", "Flow 31")) %>% 
    ggplot(aes(y = time,
               x = src,
               yend = time+.1,
               xend = dst,
               color = !grepl("True", flow))) +
    geom_segment() +
    scale_y_reverse() +
    theme_ipsum_rc() +
    labs(color = "Low latency") +
    facet_wrap(~flow)
```

```{r large, }
library(data.table)
opera_large <- read_csv("opera-websearch.csv", col_types = "iiiiii")
opera_flows <- opera_large %>%
    group_by(flow) %>%
        summarize(size = n_distinct(packet)*1500/1e6,
                  n_packets = n(),
                  start = min(time),
                  stop  = max(time)) %>%
        ungroup() %>% 
    mutate(fct = stop-start)

flows <- read_csv("../simulator/flows.csv")
packets_per_flow <- opera_flows %>%
    group_by(n_packets) %>%
        summarize(count = n()) %>% 
        ungroup() %>% 
    mutate(mb    = n_packets*1500/1e6)

packets_per_flow %>%
    ggplot(aes(x = mb,
               y = count)) +
    geom_point()

opera_flows %>%
    ggplot(aes(x = size,
               y = fct,
               color = size < 1)) +
    geom_jitter() +
    scale_y_log10(label=comma) +
    scale_x_log10(label=comma) +
    theme_ipsum_rc() +
    labs(title = "FCT for Chen distributionâ„¢",
         x = "Flow size (MB)",
         y = "Flow completion time (ms)",
         caption = "github.com/nibrivia/rotorsim")
```
