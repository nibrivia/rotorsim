---
title: "opera comparison"
author: "Olivia Brode-Roger"
date: "1/29/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---


```{r data, }
  
require(tidyverse)
require(scales)
require(hrbrthemes)

load_experiments <- function() {
  tibble(filename = list.files(path = "../data/",
                               pattern = ".*ms(.+-){4}.+.csv",
                               full.names = TRUE)) %>% 
    mutate(metadata = map(filename, read_csv, n_max = 1)) %>% 
    unnest(metadata) %>% 
    mutate(done = grepl("done", filename)) %>% 
    bind_rows(
      tibble(filename = list.files(path = "../data/", pattern = "^129-21:.*,5-chen-.*-10000ms.csv", full.names = TRUE)) %>% 
        mutate(n_xpand = 5,
               n_tor   = 129,
               n_switches = 21,
               time_limit = 10000,
               workload   = "chen",
               load       = filename %>% str_extract("[01]\\.[0-9]+") %>% as.numeric(),
               n_rotor = ifelse(grepl("0,5", filename), 16, 8),
               n_cache = ifelse(grepl("0,5", filename), 16, 8),
        )
    )
}
```

```{r}
opera_cmp_plot <- function(dir, flow_fns) {
  experiments <- tibble(filename = flow_fns) %>%
      mutate(exp_id     = seq_along(filename),
             base_fn    = strsplit(flow_fns, "ms.csv") %>% map_chr(1),# %>% strsplit("drain-") %>% map_chr(2) ,
             split = strsplit(base_fn, "-"),
             n_tor      = as.integer(map_chr(split, 1)),
             n_switches = strsplit(map_chr(split, 2), ":"),
             n_xpand    = as.integer(map_chr(n_switches, 2) %>% strsplit(., ",") %>% map(2)),
             n_cache    = as.integer(map_chr(n_switches, 2) %>% strsplit(., ",") %>% map(1)),
             n_switches = as.integer(map_chr(n_switches, 1)),
             workload   = map_chr(split, 3),
             load       = as.double(map_chr(split, 4)),
             duration   = as.integer(map_chr(split, 5))) %>% 
      #filter(n_cache %in% c(0)) %>% 
      #filter(load %in% c(.1, .4, .8)) %>% 
      select(-split, -base_fn)
  
  flows_nest <- experiments %>% 
    mutate(arrivals = map(paste0(dir, filename), read_csv, col_types = "--iid-dd")) %>% 
    mutate(arrivals = map2(arrivals, exp_id, ~ .x %>% mutate(exp_id = .y)))
  
  flows <- bind_rows(flows_nest$arrivals)
  rm(flows_nest)
  gc()
  
  exp <- experiments[1, ]
  exp$duration <- max(flows$end, na.rm = TRUE)
  lower_limit <- tibble(size_b = 10^(seq(2, 9, length.out = 100)),
                        delay   = (size_b*8/10e9+500e-9)*1e6)
  fcts <- flows %>%
    filter(!is.na(fct)) %>% 
    #filter(load == .01) %>% 
    group_by(exp_id, size) %>% 
      summarize(fct99 = quantile(fct, .99),
                fct   = mean(fct),
                n     = n()) %>% 
      ungroup() %>% 
    left_join(experiments, by = "exp_id") %>% 
    mutate(fct = ifelse(load <= .01, fct, fct99),
           load_name = paste0(100*load, "% load, ", ifelse(load == 0.01, "avg", "99%-ile")))
  

  
  opera_colors <- 
    tribble(
      ~load, ~color,   ~shape,
      .01,   "blue",   1,
      .10,   "red",    3,
      .25,   "orange", 4,
      .30,   "purple", 5,
      .40,   "green",  8
    )
  
  fcts %>% 
    #left_join(opera_colors) %>% 
    mutate(load = as_factor(load*100)) %>% 
    
    #sample_n(10000) %>% 
    #filter(load == .01) %>% 
    ggplot(aes(x = size/8,
               y = fct*1e3,
               color = load_name,
               shape = load_name,
               group = exp_id)) +
    geom_line(show.legend = T) +
    #geom_text(aes(label = n), nudge_y=.5, angle = 45) +
    geom_point() +
    geom_line(data = lower_limit, aes(x=size_b, y = delay), linetype = "dashed",
              inherit.aes = F) +
    geom_vline( xintercept = 15e6, color = "red", linetype = "dashed") +
    scale_x_log10(breaks = 10^(-10:10), label = label_math(format = log10)) +
    scale_y_log10(breaks = 10^((-5:5)*2), label = label_math(format = log10)) +
    theme_ipsum_rc() +
    #scale_color_manual(values = opera_colors$color) +
    #scale_shape_manual(values = opera_colors$shape) +
    
    theme(legend.position = c(.85, .3)) +
    labs(title = "Datamining flow completion times",
         subtitle = paste0(exp$n_tor, " tors ",
                           "for ", exp$duration, "ms. ",
                           exp$n_switches, " switches: ",
                           exp$n_cache, " cache, ",
                           exp$n_xpand, " xpand. "
         ),
         color = NULL, shape = NULL,
         x = "Flow size (bytes)",
         y = "Flow completion time (Î¼s)",
         caption = "github.com/nibrivia/rotorsim")
}

tput_plot <- function(tput_experiments) {
  tputs <<- tput_experiments %>% 
    filter(load < 0.2) %>% 
    mutate(arrivals = map(filename,
                           function(fn) {
                             fread(fn, skip = "flow_id") %>% 
                               group_by(src) %>%
                                 summarize(gbits_sent  = sum(sent/1e9),
                                           max_t      = max(end)) %>%
                                ungroup() %>% 
                               summarize(mean_sent = mean(gbits_sent)/max(max_t/1e3),
                                         max_time  = max(max_t))
                               })) %>% 
    unnest(arrivals)
  
  
  # tputs <<- flows %>%
  #   group_by(exp_id, src) %>%
  #     summarize(gbits_sent = sum(size)/1e9,
  #               max_time   = max(start+fct)) %>%
  #   group_by(exp_id) %>%
  #     summarize(max_time  = max(max_time),
  #               mean_sent = mean(gbits_sent)*1e9/(max_time*1e3)) %>%
  #   left_join(experiments, by = "exp_id")
    
  exp <- experiments[1, ]
  exp$duration <- min(tputs$max_time, na.rm = TRUE)
  tputs %>%
    ggplot(aes(x = load,
               y = mean_sent,
               color = n_cache > 0)) +
    geom_point() +
    geom_line() +
    geom_text(aes(label = round(max_time)),
              color = "black",
              hjust = "inward", vjust = "inward") +
    
    scale_x_percent(   limits = c(0, 1)) +
    scale_y_continuous(limits = c(0, NA)) +
    
    theme_ipsum_rc() +
    theme(legend.position = c(.85, .15)) +
    labs(title = "Throughput of skewed workload by load",
         subtitle = paste0(exp$n_tor, " tors ",
                           "for ", round(exp$duration), "ms. ",
                           exp$n_switches, " switches: ",
                           exp$n_cache, " cache, ",
                           exp$n_xpand, " xpand. "
         ),
         color = "Cachenet",
         x = NULL,
         y = "Mean ToR tput (Gb/s)",
         caption = "github.com/nibrivia/rotorsim")
}

dir <- "../simulator/"
flow_fns <- list.files(path = dir, pattern = "108-13.*-datamining-0.*-10000ms.csv")
#opera_cmp_plot(dir, flow_fns)



tput_experiments <- experiments %>% 
  mutate(load = round(load, digits = 3)) %>% 
  ungroup() %>% 
    filter(n_xpand == 21) %>%
    group_by(load) %>%
      top_n(1, timestamp) %>% 
      slice(1) %>% # break ties
      ungroup()
tput_plot(tput_experiments)
```

```{r}
mt_old <- file.mtime(paste0(dir, flow_fns))
while(TRUE) {
  mt_new <- file.mtime(paste0(dir, flow_fns))
  if (mt_new != mt_old) {
    try({p <<- opera_cmp_plot(dir, flow_fns)})
    print(p)
    mt_old <- mt_new
  }
  Sys.sleep(5)
}
```
